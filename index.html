<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è²¨å¹£æŠ•è³‡ç®¡å®¶</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡ç®¡å®¶">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2953/2953363.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827' },
              blue: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
            }
          }
        }
      }
    </script>
    <style>
       body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
       .safe-top { padding-top: env(safe-area-inset-top); }
       .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
       .no-scrollbar::-webkit-scrollbar { display: none; }
       .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
       
       @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
       }
       .animate-shake { animation: shake 0.2s ease-in-out; }

       /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (PDFç”¢ç”Ÿä¾æ“š) --- */
       @media print {
          #mobile-app-root, .toast-container, .modal-container, .warning-container { display: none !important; }
          #print-report-root { display: block !important; }
          @page { size: A4; margin: 1.5cm; }
          body { background-color: white !important; color: black !important; overflow: visible !important; height: auto !important; }
          * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
       }
       #print-report-root { display: none; }
    </style>

    <!-- æ ¸å¿ƒåº« -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- åœ–è¡¨åº« (æŒ‡å®šç©©å®šç‰ˆæœ¬) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>
    
    <!-- åœ–æ¨™åº« -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 text-gray-900 h-screen w-screen overflow-hidden">
    <!-- æ‰‹æ©Ÿç‰ˆ App å®¹å™¨ -->
    <div id="mobile-app-root" class="h-full w-full overflow-y-auto no-scrollbar"></div>
    
    <!-- åˆ—å°ç‰ˆ å ±è¡¨å®¹å™¨ -->
    <div id="print-report-root" class="bg-white p-8"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // å®‰å…¨ç²å– Recharts å°è±¡ï¼Œé˜²æ­¢å› ç¶²è·¯å•é¡Œå°è‡´å´©æ½°
        const RechartsObj = window.Recharts || { 
            PieChart: () => null, 
            Pie: () => null, 
            Cell: () => null, 
            ResponsiveContainer: ({children}) => <div>{children}</div>, 
            Tooltip: () => null, 
            Legend: () => null 
        };
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = RechartsObj;
        
        // Icons
        const Icons = {
            PlusCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            MinusCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>,
            History: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>,
            LayoutDashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Wallet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            ArrowRightLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6 9 17l-5-5"/></svg>,
            Edit2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Share: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>,
            Smartphone: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ShieldCheck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Printer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            FileDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
        };

        const DEFAULT_CURRENCIES = ["USD", "JPY", "EUR", "CNY", "AUD", "GBP", "CAD", "SGD", "HKD", "KRW"];
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#ff7300'];

        function PrintReport({ history, portfolio, marketRates }) {
           const formatNumber = (num, decimals = 2) => isNaN(num) ? "0.00" : new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
           const totalValue = Object.keys(portfolio).reduce((acc, curr) => acc + (portfolio[curr].amount * (marketRates[curr] || portfolio[curr].avgCost)), 0);
           
           // æº–å‚™åˆ—å°ç”¨è³‡æ–™ (æ’åºå¾Œ)
           const sortedHistory = [...history].sort((a,b) => new Date(a.date) - new Date(b.date));

           return (
             <div className="text-black text-sm">
               <div className="flex justify-between items-end border-b-2 border-black pb-2 mb-6">
                 <div>
                   <h1 className="text-3xl font-bold">æŠ•è³‡è³‡ç”¢å ±è¡¨</h1>
                   <p className="text-gray-600 mt-1">å»ºç«‹æ—¥æœŸ: {new Date().toLocaleDateString()}</p>
                 </div>
                 <div className="text-right">
                   <p className="text-gray-600 text-sm">é ä¼°ç¸½ç¾å€¼</p>
                   <p className="text-2xl font-bold">NT$ {formatNumber(totalValue, 0)}</p>
                 </div>
               </div>

               {/* Section 1: è³‡ç”¢ç¸½è¡¨ */}
               <div className="mb-8">
                 <h2 className="text-lg font-bold mb-3 border-l-4 border-gray-800 pl-2">1. æŒæœ‰éƒ¨ä½ç¸½è¦½</h2>
                 <table className="w-full border-collapse border border-gray-300 text-sm">
                   <thead>
                     <tr className="bg-gray-100">
                       <th className="border p-2 text-left">è²¨å¹£</th>
                       <th className="border p-2 text-right">æŒæœ‰æ•¸é‡</th>
                       <th className="border p-2 text-right">å¹³å‡æˆæœ¬</th>
                       <th className="border p-2 text-right">åƒè€ƒå¸‚åƒ¹</th>
                       <th className="border p-2 text-right">é ä¼°ç¾å€¼ (TWD)</th>
                     </tr>
                   </thead>
                   <tbody>
                     {Object.keys(portfolio).filter(c => portfolio[c].amount > 0.0001).map(curr => {
                       const item = portfolio[curr];
                       const rate = marketRates[curr] || item.avgCost;
                       return (
                         <tr key={curr}>
                           <td className="border p-2 font-bold">{curr}</td>
                           <td className="border p-2 text-right">{formatNumber(item.amount)}</td>
                           <td className="border p-2 text-right">{formatNumber(item.avgCost, 4)}</td>
                           <td className="border p-2 text-right">{formatNumber(rate, 4)}</td>
                           <td className="border p-2 text-right font-bold">{formatNumber(item.amount * rate, 0)}</td>
                         </tr>
                       )
                     })}
                     {Object.keys(portfolio).filter(c => portfolio[c].amount > 0.0001).length === 0 && (
                       <tr><td colSpan="5" className="border p-4 text-center text-gray-500">ç„¡æŒæœ‰è³‡ç”¢</td></tr>
                     )}
                   </tbody>
                 </table>
               </div>

               {/* Section 2: äº¤æ˜“æµæ°´å¸³ */}
               <div>
                 <h2 className="text-lg font-bold mb-3 border-l-4 border-gray-800 pl-2">2. å®Œæ•´äº¤æ˜“ç´€éŒ„ (å‚™ä»½ç”¨)</h2>
                 <p className="text-xs text-gray-500 mb-2">* æ­¤è¡¨æ ¼åŒ…å«é‡å»ºå¸³æˆ¶æ‰€éœ€çš„æ‰€æœ‰åŸå§‹è³‡æ–™ï¼Œè«‹å¦¥å–„ä¿å­˜ã€‚</p>
                 <table className="w-full border-collapse border border-gray-300 text-xs">
                   <thead>
                     <tr className="bg-gray-100">
                       <th className="border p-2 text-left">æ—¥æœŸ</th>
                       <th className="border p-2 text-center">é¡åˆ¥</th>
                       <th className="border p-2 text-left">è²¨å¹£</th>
                       <th className="border p-2 text-right">é‡‘é¡</th>
                       <th className="border p-2 text-right">åŒ¯ç‡/æˆæœ¬</th>
                       <th className="border p-2 text-right">å‚™è¨»</th>
                     </tr>
                   </thead>
                   <tbody>
                     {sortedHistory.map((item, idx) => (
                       <tr key={item.id}>
                         <td className="border p-2">{item.date}</td>
                         <td className="border p-2 text-center">{item.type === 'DEPOSIT' ? 'å­˜å…¥' : 'æå‡º'}</td>
                         <td className="border p-2 font-bold">{item.currency}</td>
                         <td className="border p-2 text-right">{formatNumber(item.amount)}</td>
                         <td className="border p-2 text-right">{item.type === 'DEPOSIT' ? formatNumber(item.rate, 4) : '-'}</td>
                         <td className="border p-2 text-gray-500 text-center">{idx + 1}</td>
                       </tr>
                     ))}
                     {sortedHistory.length === 0 && (
                       <tr><td colSpan="6" className="border p-4 text-center text-gray-500">å°šç„¡äº¤æ˜“è³‡æ–™</td></tr>
                     )}
                   </tbody>
                 </table>
               </div>
             </div>
           );
        }

        function App() {
          const [history, setHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('currency_history')) || []; } catch (e) { return []; } });
          const [marketRates, setMarketRates] = useState(() => { try { return JSON.parse(localStorage.getItem('currency_rates')) || {}; } catch (e) { return {}; } });
          const [appPin, setAppPin] = useState(() => localStorage.getItem('app_pin') || null);
          const [portfolio, setPortfolio] = useState({});
          
          const [activeTab, setActiveTab] = useState('dashboard');
          const [transType, setTransType] = useState('DEPOSIT');
          const [selectedCurrency, setSelectedCurrency] = useState('USD');
          const [amount, setAmount] = useState('');
          const [rate, setRate] = useState('');
          const [transDate, setTransDate] = useState(new Date().toISOString().substr(0, 10));
          const [saveStatus, setSaveStatus] = useState('saved'); 
          const [editingId, setEditingId] = useState(null);
          
          const [isPasteMode, setIsPasteMode] = useState(false);
          const [pasteContent, setPasteContent] = useState('');
          
          const [isLocked, setIsLocked] = useState(!!localStorage.getItem('app_pin'));
          const [pinInput, setPinInput] = useState('');
          const [pinError, setPinError] = useState(false);
          
          const [notification, setNotification] = useState(null); 
          const [modalConfig, setModalConfig] = useState(null);
          const [isInAppBrowser, setIsInAppBrowser] = useState(false);
          const [isPersisted, setIsPersisted] = useState(false);

          useEffect(() => {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if ((ua.indexOf("Line") > -1) || (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1)) setIsInAppBrowser(true);
            if (navigator.storage && navigator.storage.persist) navigator.storage.persist().then(granted => setIsPersisted(granted));
          }, []);

          useEffect(() => {
            setSaveStatus('saving');
            const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
            const newPortfolio = {};
            sortedHistory.forEach(tx => {
              const curr = tx.currency;
              if (!newPortfolio[curr]) newPortfolio[curr] = { amount: 0, avgCost: 0 };
              const currentData = newPortfolio[curr];
              if (tx.type === 'DEPOSIT') {
                const totalCostBefore = currentData.amount * currentData.avgCost;
                const newCostInjection = tx.amount * tx.rate;
                const newTotalAmount = currentData.amount + tx.amount;
                const newAvgCost = newTotalAmount > 0 ? (totalCostBefore + newCostInjection) / newTotalAmount : 0;
                newPortfolio[curr] = { amount: newTotalAmount, avgCost: newAvgCost };
              } else {
                const newTotalAmount = currentData.amount - tx.amount;
                newPortfolio[curr] = { amount: newTotalAmount, avgCost: currentData.avgCost };
              }
            });
            setPortfolio(newPortfolio);
            localStorage.setItem('currency_history', JSON.stringify(history));
            setTimeout(() => setSaveStatus('saved'), 500);
          }, [history]);

          useEffect(() => localStorage.setItem('currency_rates', JSON.stringify(marketRates)), [marketRates]);

          const showToast = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };
          const openConfirm = (config) => setModalConfig(config);
          const closeConfirm = () => setModalConfig(null);
          const formatNumber = (num, decimals = 2) => isNaN(num) ? "0.00" : new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
          const calculateTotalAssetValueTWD = useMemo(() => {
            let total = 0;
            Object.keys(portfolio).forEach(curr => total += portfolio[curr].amount * (marketRates[curr] || portfolio[curr].avgCost));
            return total;
          }, [portfolio, marketRates]);

          const handlePinSubmit = (val) => {
            if (val.length === 4) { if (val === appPin) { setIsLocked(false); setPinError(false); } else { setPinError(true); setTimeout(() => { setPinInput(''); setPinError(false); }, 500); } } else setPinInput(val);
          };
          const handleSetPin = (newPin) => { if (!newPin) { localStorage.removeItem('app_pin'); setAppPin(null); showToast("å¯†ç¢¼é–å·²ç§»é™¤"); } else { localStorage.setItem('app_pin', newPin); setAppPin(newPin); showToast("å¯†ç¢¼é–å·²è¨­å®š"); } };
          const handleTransactionSubmit = (e) => {
            e.preventDefault();
            if (!amount || parseFloat(amount) <= 0) { showToast("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡", 'error'); return; }
            if (transType === 'DEPOSIT' && (!rate || parseFloat(rate) <= 0)) { showToast("è«‹è¼¸å…¥åŒ¯ç‡", 'error'); return; }
            const newTx = { id: editingId || Date.now(), date: transDate, currency: selectedCurrency, amount: parseFloat(amount), rate: parseFloat(rate) || 0, type: transType };
            if (transType === 'DEPOSIT') setMarketRates(prev => ({ ...prev, [selectedCurrency]: parseFloat(rate) }));
            if (editingId) { setHistory(prev => prev.map(item => item.id === editingId ? newTx : item)); setEditingId(null); showToast("äº¤æ˜“å·²ä¿®æ”¹"); } else { setHistory(prev => [...prev, newTx]); showToast("äº¤æ˜“å·²æ–°å¢"); }
            setAmount(''); if (transType === 'DEPOSIT') setRate(''); setActiveTab('dashboard');
          };
          const handleEditClick = (item) => { setEditingId(item.id); setTransDate(item.date); setTransType(item.type); setSelectedCurrency(item.currency); setAmount(item.amount); setRate(item.rate); setActiveTab('transaction'); window.scrollTo(0,0); };
          const handleDeleteClick = (id) => openConfirm({ title: "åˆªé™¤äº¤æ˜“", msg: "ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿç³»çµ±å°‡é‡æ–°è¨ˆç®—æŒå€‰æˆæœ¬ã€‚", isDanger: true, confirmText: "åˆªé™¤", onConfirm: () => { setHistory(prev => prev.filter(item => item.id !== id)); showToast("å·²åˆªé™¤"); closeConfirm(); }});
          const handleRateUpdate = (curr, val) => setMarketRates(prev => ({ ...prev, [curr]: parseFloat(val) }));
          const getBackupData = () => JSON.stringify({ history, marketRates, exportDate: new Date().toISOString() });
          const handleExport = () => { try { const blob = new Blob([getBackupData()], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `currency_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); setTimeout(() => { document.body.removeChild(link); window.URL.revokeObjectURL(url); }, 0); showToast("ä¸‹è¼‰é–‹å§‹"); } catch (e) { showToast("åŒ¯å‡ºå¤±æ•—", 'error'); } };
          const handleImportFile = (e) => { const fileReader = new FileReader(); if (!e.target.files[0]) return; fileReader.readAsText(e.target.files[0], "UTF-8"); fileReader.onload = event => processImport(event.target.result); e.target.value = null; };
          const handlePasteImport = () => { if (!pasteContent) { showToast("è«‹è²¼ä¸Šä»£ç¢¼", 'error'); return; } processImport(pasteContent); };
          const processImport = (jsonString) => { try { const imported = JSON.parse(jsonString.trim()); if (imported.history) openConfirm({ title: "é‚„åŸè³‡æ–™", msg: `å‚™ä»½æ—¥æœŸ: ${imported.exportDate ? imported.exportDate.slice(0,10) : 'æœªçŸ¥'}\nå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ`, isDanger: true, confirmText: "é‚„åŸ", onConfirm: () => { setHistory(imported.history); setMarketRates(imported.marketRates || {}); setPasteContent(''); setIsPasteMode(false); showToast("é‚„åŸæˆåŠŸ"); closeConfirm(); } }); else showToast("æ ¼å¼éŒ¯èª¤", 'error'); } catch (err) { showToast("è®€å–å¤±æ•—", 'error'); } };
          const handleCopyToClipboard = async () => { try { await navigator.clipboard.writeText(getBackupData()); showToast("å·²è¤‡è£½ä»£ç¢¼"); } catch (err) { const ta = document.createElement("textarea"); ta.value = getBackupData(); document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("å·²è¤‡è£½ä»£ç¢¼"); } };
          const clearHistory = () => openConfirm({ title: "æ¸…é™¤æ‰€æœ‰è³‡æ–™", msg: "è¼¸å…¥ 'DELETE' ç¢ºèªæ¸…é™¤ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚", isDanger: true, confirmText: "ç¢ºèª", requireInput: true, onConfirm: () => { setHistory([]); setMarketRates({}); const pin = localStorage.getItem('app_pin'); localStorage.clear(); if(pin) localStorage.setItem('app_pin', pin); showToast("å·²æ¸…é™¤"); closeConfirm(); } });

          // Render Partial Views
          const LockScreen = () => isLocked ? (<div className="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6 text-white"><div className="mb-8 text-center"><div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg"><Icons.Lock className="w-8 h-8"/></div><h2 className="text-xl font-bold mb-2">è«‹è¼¸å…¥å¯†ç¢¼</h2></div><div className="flex gap-4 mb-12">{[0,1,2,3].map(i => <div key={i} className={`w-4 h-4 rounded-full transition-all duration-300 ${pinInput.length > i ? 'bg-blue-500 scale-110 shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'bg-gray-700'} ${pinError ? 'bg-red-500 animate-shake' : ''}`}/>)}</div><div className="grid grid-cols-3 gap-6 w-full max-w-xs">{[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={() => handlePinSubmit(pinInput + n)} className="aspect-square rounded-full bg-gray-800 text-2xl font-medium border border-gray-700 active:scale-95">{n}</button>)}<div className="aspect-square"></div><button onClick={() => handlePinSubmit(pinInput + '0')} className="aspect-square rounded-full bg-gray-800 text-2xl font-medium border border-gray-700 active:scale-95">0</button><button onClick={() => setPinInput(prev => prev.slice(0, -1))} className="aspect-square rounded-full text-gray-400 font-bold active:scale-95">åˆªé™¤</button></div><div className="mt-8"><button onClick={() => window.confirm("å¿˜è¨˜å¯†ç¢¼ï¼Ÿå°‡é‡ç½®æ‰€æœ‰è³‡æ–™ã€‚") && (localStorage.clear(), window.location.reload())} className="text-xs text-gray-500 underline">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ(é‡ç½®)</button></div></div>) : null;
          const InAppBrowserWarning = () => isInAppBrowser ? <div className="warning-container fixed inset-0 z-[200] bg-gray-900/95 flex items-center justify-center p-6 text-center"><div className="bg-white rounded-2xl p-6"><Icons.AlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-4"/><h2 className="text-xl font-bold mb-2">è«‹å‹¿ä½¿ç”¨ LINE/FB é–‹å•Ÿ</h2><p className="text-gray-600 text-sm">è«‹ä½¿ç”¨ Safari/Chrome é–‹å•Ÿã€‚</p></div></div> : null;
          const Modal = () => modalConfig ? <div className="modal-container fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"><div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6"><h3 className="text-lg font-bold mb-2">{modalConfig.title}</h3><p className="text-gray-600 text-sm mb-4 whitespace-pre-wrap">{modalConfig.msg}</p>{modalConfig.requireInput && <input type="text" placeholder="è¼¸å…¥ DELETE" className="w-full p-2 border mb-4 text-center" onChange={e => { window.tempInput = e.target.value; }} />}<div className="flex gap-3"><button onClick={closeConfirm} className="flex-1 py-2 bg-gray-100 rounded-lg">å–æ¶ˆ</button><button onClick={() => { if(modalConfig.requireInput && window.tempInput !== 'DELETE') return; modalConfig.onConfirm(); }} className={`flex-1 py-2 text-white rounded-lg ${modalConfig.isDanger ? 'bg-red-600' : 'bg-blue-600'}`}>{modalConfig.confirmText}</button></div></div></div> : null;
          const Toast = () => notification ? <div className={`toast-container fixed top-4 left-1/2 -translate-x-1/2 z-[70] px-6 py-3 rounded-full shadow-lg text-white text-sm font-bold ${notification.type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`}>{notification.msg}</div> : null;

          return (
            <>
              {/* === Mobile App View === */}
              <div id="mobile-app-root" className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-safe-bottom">
                  <LockScreen />
                  <InAppBrowserWarning />
                  <Modal />
                  <Toast />
                  
                  <div className="bg-white border-b border-gray-200 px-4 py-4 sticky top-0 z-40 safe-top flex justify-between items-center">
                     <div className="w-8"></div><h1 className="font-bold text-lg">è²¨å¹£æŠ•è³‡ç®¡å®¶</h1><div className="w-8 flex justify-end">{saveStatus === 'saved' ? <Icons.Check className="w-5 h-5 text-green-500"/> : <div className="w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>}</div>
                  </div>

                  <main className="p-4 max-w-md mx-auto min-h-[calc(100vh-140px)]">
                    {activeTab === 'dashboard' && (
                      <div className="space-y-6 pb-20">
                         <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden"><div className="relative z-10"><h2 className="text-sm opacity-80 mb-1">é ä¼°å°å¹£ç¸½ç¾å€¼</h2><div className="text-4xl font-bold tracking-tight">NT$ {formatNumber(calculateTotalAssetValueTWD, 0)}</div></div></div>
                         <div><h3 className="text-lg font-bold text-gray-800 mb-3 px-2 flex items-center"><Icons.Wallet className="w-5 h-5 mr-2 text-blue-600"/>æŒæœ‰éƒ¨ä½</h3><div className="space-y-3">{Object.keys(portfolio).filter(c => portfolio[c].amount > 0.0001).length === 0 ? <div className="text-center py-10 text-gray-400 bg-gray-50 rounded-xl">å°šç„¡è³‡ç”¢</div> : Object.keys(portfolio).filter(k => portfolio[k].amount > 0.0001).map(curr => { const item = portfolio[curr]; const cp = marketRates[curr] || item.avgCost; const pf = (item.amount * cp) - (item.amount * item.avgCost); return (<div key={curr} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div className="flex justify-between items-start mb-2"><div className="flex items-center"><div className="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded-lg text-sm mr-2">{curr}</div><div className="text-gray-500 text-xs">ç¾åƒ¹: {formatNumber(cp)}</div></div><div className="text-lg font-bold">{formatNumber(item.amount)}</div></div><div className="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-gray-50"><div><div className="text-xs text-gray-400">å¹³å‡æˆæœ¬</div><div className="font-semibold">{formatNumber(item.avgCost, 4)}</div></div><div className="text-right"><div className="text-xs text-gray-400">æç›Š</div><div className={`font-semibold ${pf>=0?'text-green-600':'text-red-500'}`}>{formatNumber(pf,0)}</div></div></div></div>); })}</div></div>
                         {Object.keys(portfolio).some(k=>portfolio[k].amount>0) && <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-64"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={Object.keys(portfolio).filter(k=>portfolio[k].amount>0.0001).map(k=>({name:k, value:portfolio[k].amount*(marketRates[k]||portfolio[k].avgCost)}))} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">{Object.keys(portfolio).map((_,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Pie><Legend/></PieChart></ResponsiveContainer></div>}
                      </div>
                    )}
                    {activeTab === 'transaction' && (
                      <div className="pb-20">
                         <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">{editingId?'ä¿®æ”¹':'æ–°å¢'}äº¤æ˜“</h2>{editingId && <button onClick={()=>{setEditingId(null);setAmount('');setRate('');}} className="text-sm bg-gray-100 px-3 py-1 rounded-full flex items-center"><Icons.X className="w-3 h-3 mr-1"/>å–æ¶ˆ</button>}</div>
                         <form onSubmit={handleTransactionSubmit} className="space-y-6">
                           <div className="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-xl"><button type="button" onClick={()=>setTransType('DEPOSIT')} className={`py-3 rounded-lg text-sm font-bold ${transType==='DEPOSIT'?'bg-white text-blue-600 shadow-sm':'text-gray-500'}`}>å­˜å…¥</button><button type="button" onClick={()=>setTransType('WITHDRAWAL')} className={`py-3 rounded-lg text-sm font-bold ${transType==='WITHDRAWAL'?'bg-white text-red-600 shadow-sm':'text-gray-500'}`}>æå‡º</button></div>
                           <div><label className="block text-sm font-medium mb-2">å¹£åˆ¥</label><select value={selectedCurrency} onChange={e=>setSelectedCurrency(e.target.value)} disabled={!!editingId} className="w-full p-4 bg-white border border-gray-200 rounded-xl text-lg outline-none">{DEFAULT_CURRENCIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                           <div><label className="block text-sm font-medium mb-2">é‡‘é¡</label><input type="number" step="any" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0.00" className="w-full p-4 bg-white border border-gray-200 rounded-xl text-2xl font-bold outline-none" required/></div>
                           {transType==='DEPOSIT'&&<div><label className="block text-sm font-medium mb-2">åŒ¯ç‡</label><input type="number" step="any" value={rate} onChange={e=>setRate(e.target.value)} placeholder="TWD" className="w-full p-4 bg-white border border-gray-200 rounded-xl text-xl outline-none" required/></div>}
                           <div><label className="block text-sm font-medium mb-2">æ—¥æœŸ</label><input type="date" value={transDate} onChange={e=>setTransDate(e.target.value)} className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none"/></div>
                           <button type="submit" className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg ${transType==='DEPOSIT'?'bg-blue-600':'bg-red-500'}`}>{editingId?'å„²å­˜':'ç¢ºèª'}</button>
                         </form>
                      </div>
                    )}
                    {activeTab === 'history' && (
                      <div className="pb-20"><h2 className="text-xl font-bold mb-6">æ­·å²ç´€éŒ„</h2><div className="space-y-4">{history.length===0?<div className="text-center py-10 text-gray-400">å°šç„¡ç´€éŒ„</div>:history.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(item=>(<div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div className="flex justify-between items-start mb-2"><div><div className="text-xs text-gray-400 mb-1">{item.date}</div><div className="font-bold flex items-center">{item.currency}<span className={`ml-2 text-xs px-2 py-0.5 rounded ${item.type==='DEPOSIT'?'bg-blue-100 text-blue-700':'bg-red-100 text-red-700'}`}>{item.type==='DEPOSIT'?'å­˜å…¥':'æå‡º'}</span></div></div><div className={`text-lg font-bold ${item.type==='DEPOSIT'?'text-blue-600':'text-red-500'}`}>{item.type==='DEPOSIT'?'+':'-'}{formatNumber(item.amount)}</div></div><div className="flex justify-between items-center pt-2 border-t border-gray-50 mt-2"><div className="text-xs text-gray-500">{item.type==='DEPOSIT'?`åŒ¯ç‡: ${item.rate}`:'äº¤æ˜“'}</div><div className="flex gap-2"><button onClick={()=>handleEditClick(item)} className="p-2 text-gray-400 hover:text-blue-600"><Icons.Edit2 className="w-4 h-4"/></button><button onClick={()=>handleDeleteClick(item.id)} className="p-2 text-gray-400 hover:text-red-600"><Icons.Trash2 className="w-4 h-4"/></button></div></div></div>))}</div></div>
                    )}
                    {activeTab === 'settings' && (
                      <div className="pb-20">
                        <h2 className="text-xl font-bold mb-6">è¨­å®š</h2>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6 p-4">
                           <button onClick={()=>window.print()} className="w-full py-4 bg-gray-800 text-white rounded-xl font-bold flex items-center justify-center shadow-lg hover:bg-black transition-colors mb-2"><Icons.Printer className="w-6 h-6 mr-2"/>ğŸ–¨ï¸ åˆ—å°å ±è¡¨ / å­˜æˆ PDF</button>
                           <p className="text-xs text-center text-gray-500 leading-relaxed">
                              â€¢ <strong>iPhone:</strong> é»æ“Šä¸Šæ–¹æŒ‰éˆ• -> é è¦½ç•«é¢é»æ“Šã€Œåˆ†äº«ã€åœ–ç¤º -> é¸æ“‡ã€Œå„²å­˜åˆ°æª”æ¡ˆã€å³å¯å­˜æˆ PDFã€‚<br/>
                              â€¢ <strong>Android:</strong> é»æ“Šä¸Šæ–¹æŒ‰éˆ• -> é¸æ“‡å°è¡¨æ©Ÿæ”¹ç‚ºã€Œå„²å­˜ç‚º PDFã€ã€‚
                           </p>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6 p-4">
                          <h3 className="font-bold mb-4 flex items-center">{appPin?<Icons.Lock className="w-4 h-4 mr-2 text-blue-600"/>:<Icons.Unlock className="w-4 h-4 mr-2 text-gray-400"/>}{appPin?'å¯†ç¢¼é–å·²é–‹å•Ÿ':'è¨­å®šå¯†ç¢¼é–'}</h3>
                          {!appPin ? <div className="flex gap-2"><input type="tel" maxLength={4} placeholder="è¼¸å…¥4ä½æ•¸" id="pinInput" className="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-lg text-center font-bold outline-none"/><button onClick={()=>{const val=document.getElementById('pinInput').value; if(val.length===4)handleSetPin(val); else showToast("è«‹è¼¸å…¥4ä½æ•¸",'error');}} className="bg-blue-600 text-white px-6 rounded-lg font-bold">è¨­å®š</button></div> : <button onClick={()=>openConfirm({title:"ç§»é™¤å¯†ç¢¼",msg:"ç¢ºå®šç§»é™¤ï¼Ÿ",isDanger:true,confirmText:"ç§»é™¤",onConfirm:()=>handleSetPin(null)})} className="w-full py-3 border border-red-200 text-red-600 rounded-lg font-bold flex items-center justify-center">ç§»é™¤å¯†ç¢¼é–</button>}
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden p-4">
                          <h3 className="font-bold mb-4">æ•¸ä½å‚™ä»½</h3>
                          <div className="grid grid-cols-2 gap-3 mb-4"><button onClick={handleExport} className="bg-gray-50 hover:bg-gray-100 text-gray-700 py-3 rounded-xl text-sm font-bold flex items-center justify-center"><Icons.FileDown className="w-4 h-4 mr-2"/>ä¸‹è¼‰æª”æ¡ˆ</button><label className="bg-gray-50 hover:bg-gray-100 text-gray-700 py-3 rounded-xl text-sm font-bold flex items-center justify-center cursor-pointer"><Icons.Upload className="w-4 h-4 mr-2"/>é‚„åŸ<input type="file" accept=".json" onChange={handleImportFile} className="hidden"/></label></div>
                          <div className="mb-6"><button onClick={handleCopyToClipboard} className="w-full mb-3 py-3 rounded-xl text-sm font-bold bg-gray-50 text-gray-700 flex items-center justify-center"><Icons.Copy className="w-4 h-4 mr-2"/>è¤‡è£½å‚™ä»½ä»£ç¢¼</button>{!isPasteMode?<button onClick={()=>setIsPasteMode(true)} className="w-full py-3 border border-dashed border-gray-300 text-gray-500 rounded-xl text-sm font-bold flex items-center justify-center"><Icons.FileText className="w-4 h-4 mr-2"/>è²¼ä¸Šä»£ç¢¼</button>:<div className="bg-gray-50 p-3 rounded-xl border border-gray-200"><textarea value={pasteContent} onChange={e=>setPasteContent(e.target.value)} placeholder="è²¼ä¸Šä»£ç¢¼..." className="w-full h-32 p-3 text-xs font-mono bg-white border border-gray-200 rounded-lg mb-2 outline-none"/><div className="flex gap-2"><button onClick={()=>setIsPasteMode(false)} className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-bold">å–æ¶ˆ</button><button onClick={handlePasteImport} className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">é‚„åŸ</button></div></div>}</div>
                          <div className="border-t border-gray-100 pt-6"><button onClick={clearHistory} className="w-full flex items-center justify-center text-red-500 bg-red-50 hover:bg-red-100 font-medium p-3 rounded-xl text-sm"><Icons.Trash2 className="w-4 h-4 mr-2"/>æ¸…é™¤è³‡æ–™</button></div>
                        </div>
                      </div>
                    )}
                  </main>

                  <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-6 pt-2 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                     <div className="max-w-md mx-auto flex justify-around">
                       {['dashboard','transaction','history','settings'].map(tab=>(<button key={tab} onClick={()=>{setActiveTab(tab);setEditingId(null);}} className={`flex-1 py-2 flex flex-col items-center justify-center ${activeTab===tab?'text-blue-600':'text-gray-400'}`}>{tab==='dashboard'&&<Icons.LayoutDashboard className="w-6 h-6 mb-1"/>}{tab==='transaction'&&<Icons.ArrowRightLeft className="w-6 h-6 mb-1"/>}{tab==='history'&&<Icons.History className="w-6 h-6 mb-1"/>}{tab==='settings'&&<Icons.Settings className="w-6 h-6 mb-1"/>}<span className="text-[10px] font-medium">{{dashboard:'ç¸½è¦½',transaction:'äº¤æ˜“',history:'ç´€éŒ„',settings:'è¨­å®š'}[tab]}</span></button>))}
                     </div>
                  </nav>
              </div>

              {/* === Print Report View (Hidden on Mobile) === */}
              <div id="print-report-root">
                 <PrintReport history={history} portfolio={portfolio} marketRates={marketRates} />
              </div>
            </>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('mobile-app-root'));
        root.render(<App />);
    </script>
</body>
</html>